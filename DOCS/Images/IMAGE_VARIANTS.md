# ğŸ–¼ï¸ Image Variant Specification

Complete specification for image variant support in SportsArena.

---

## ğŸ“‹ Overview

The image system supports multiple size variants of each uploaded image. Variants are generated automatically after image upload and stored alongside the original image in S3.

**Key Principles:**
- âœ… Original image is always preserved
- âœ… Variants are generated on-demand (future: Lambda/Worker)
- âœ… All variants use same format as original (WebP preferred)
- âœ… Variants are served via CDN for optimal performance
- âœ… Frontend can choose appropriate variant based on use case

---

## ğŸ¯ Image Variants

### Variant Definitions

| Variant | Max Width | Use Case | Example |
|---------|-----------|----------|---------|
| `thumb` | 300px | Thumbnails, avatars, small previews | Profile images, gallery thumbnails |
| `medium` | 800px | Cards, lists, medium-sized displays | Facility cards, court listings |
| `full` | 1600px | Full-width displays, detail views | Facility detail pages, full-screen galleries |

### Variant Generation Rules

1. **Aspect Ratio:** Variants maintain original aspect ratio
2. **Format:** All variants use same format as original (WebP, JPEG, or PNG)
3. **Quality:** 
   - `thumb`: Optimized for small file size (quality: 75-80)
   - `medium`: Balanced quality/size (quality: 80-85)
   - `full`: High quality (quality: 85-90)
4. **Upscaling:** Never upscale images (if original < variant size, use original)
5. **Processing:** Variants generated asynchronously after upload confirmation

---

## ğŸ“ S3 Key Naming Convention

### Original Image

**Format:** `{entity_type}/{entity_id}/{image_id}.{extension}`

**Examples:**
```
facility/1/550e8400-e29b-41d4-a716-446655440000.webp
user/5/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
court/12/12345678-1234-1234-1234-123456789abc.png
```

### Variant Images

**Format:** `{entity_type}/{entity_id}/{image_id}_{variant}.{extension}`

**Examples:**
```
facility/1/550e8400-e29b-41d4-a716-446655440000_thumb.webp
facility/1/550e8400-e29b-41d4-a716-446655440000_medium.webp
facility/1/550e8400-e29b-41d4-a716-446655440000_full.webp
```

### Key Rules

1. **Original Key:** Base S3 key (stored in database `storage_key`)
2. **Variant Keys:** Generated by appending `_{variant}` before file extension
3. **Extension:** Same as original (determined by `contentType`)
4. **Consistency:** All variants for same image share same base path

---

## ğŸ”§ Backend Implementation

### Helper Functions

The backend provides utility functions to generate variant S3 keys and URLs:

```javascript
// Generate variant S3 key
const variantKey = generateVariantS3Key(originalS3Key, 'thumb');
// Returns: 'facility/1/image_thumb.webp'

// Generate variant CDN URL
const variantUrl = getVariantImageUrl(originalS3Key, 'medium');
// Returns: 'https://cdn.sportsarena.com/facility/1/image_medium.webp'
```

### API Response Format

All image API responses include variant URLs:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "s3Key": "facility/1/550e8400-e29b-41d4-a716-446655440000.webp",
  "publicUrl": "https://cdn.sportsarena.com/facility/1/550e8400-e29b-41d4-a716-446655440000.webp",
  "variants": {
    "thumb": "https://cdn.sportsarena.com/facility/1/550e8400-e29b-41d4-a716-446655440000_thumb.webp",
    "medium": "https://cdn.sportsarena.com/facility/1/550e8400-e29b-41d4-a716-446655440000_medium.webp",
    "full": "https://cdn.sportsarena.com/facility/1/550e8400-e29b-41d4-a716-446655440000_full.webp"
  }
}
```

**Note:** Variant URLs are generated even if variants don't exist yet. Frontend should handle 404 errors gracefully.

---

## ğŸš€ Future Processing Hooks

### Lambda Function (Recommended)

**Trigger:** S3 Event (ObjectCreated) after image upload

**Process:**
1. Lambda receives S3 event for new image upload
2. Downloads original image from S3
3. Generates all three variants (thumb, medium, full)
4. Uploads variants to S3 with correct naming
5. Optionally: Updates image metadata in database

**Lambda Function Structure:**
```
s3-event-trigger
  â†“
Lambda Function (image-processor)
  â†“
1. Download original from S3
2. Generate variants (thumb, medium, full)
3. Upload variants to S3
4. (Optional) Update database metadata
```

### Worker Queue (Alternative)

**Process:**
1. After upload confirmation, enqueue image processing job
2. Worker processes image and generates variants
3. Uploads variants to S3
4. Updates job status

**Queue Structure:**
```
Upload Confirmation
  â†“
Enqueue Job (image-processing-queue)
  â†“
Worker Process
  â†“
1. Download original from S3
2. Generate variants
3. Upload variants to S3
4. Mark job complete
```

### Processing Library Recommendations

- **Sharp** (Node.js): Fast, efficient image processing
- **ImageMagick** (Universal): Powerful, supports many formats
- **Pillow** (Python): Good for Python-based workers

---

## ğŸ“Š Variant Availability

### Status Tracking

Variants may not exist immediately after upload. The system handles this gracefully:

- **Immediate:** Original image is available
- **Async:** Variants are generated asynchronously (1-30 seconds)
- **Fallback:** If variant doesn't exist, frontend can use original

### Frontend Handling

```javascript
// Try variant first, fallback to original
const imageUrl = image.variants?.medium || image.publicUrl;

// Or check variant availability
const loadImage = async (url) => {
  try {
    const response = await fetch(url, { method: 'HEAD' });
    if (response.ok) return url;
  } catch (error) {
    // Fallback to original
    return image.publicUrl;
  }
};
```

---

## ğŸ¨ Use Case Examples

### Profile Images
```javascript
// Use thumb variant for avatars
<img src={user.profileImage.variants.thumb} alt="Profile" />
```

### Facility Cards
```javascript
// Use medium variant for cards
<img src={facility.coverImage.variants.medium} alt="Facility" />
```

### Detail Pages
```javascript
// Use full variant for detail views
<img src={facility.gallery[0].variants.full} alt="Facility detail" />
```

### Responsive Images
```javascript
// Use srcset for responsive images
<img
  srcSet={`
    ${image.variants.thumb} 300w,
    ${image.variants.medium} 800w,
    ${image.variants.full} 1600w
  `}
  src={image.variants.medium}
  alt="Responsive image"
/>
```

---

## âœ… Summary

- **3 Variants:** thumb (300px), medium (800px), full (1600px)
- **Naming:** `{base_key}_{variant}.{ext}`
- **Format:** Same as original
- **Generation:** Async (Lambda/Worker)
- **CDN:** All variants served via CDN
- **Fallback:** Use original if variant not available

The system is designed to be scalable and performant, with variants generated on-demand and served via CDN for optimal user experience.

